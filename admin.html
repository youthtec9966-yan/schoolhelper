<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å›­ç”Ÿæ´»ç®¡ç†åå°</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; margin: 0; display: flex; height: 100vh; background-color: #f4f5f7; }
        
        /* Sidebar */
        .sidebar { width: 240px; background-color: #001529; color: #fff; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; font-size: 20px; font-weight: bold; text-align: center; border-bottom: 1px solid #002140; }
        .nav-item { padding: 15px 20px; cursor: pointer; transition: background 0.3s; }
        .nav-item:hover { background-color: #1890ff; }
        .nav-item.active { background-color: #1890ff; }
        
        /* Main Content */
        .main-content { flex: 1; padding: 20px; overflow-y: auto; }
        .section { display: none; }
        .section.active { display: block; }
        
        /* Common */
        h2 { margin-top: 0; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; color: white; font-size: 14px; }
        .btn-primary { background-color: #1890ff; }
        .btn-danger { background-color: #ff4d4f; }
        .btn-success { background-color: #52c41a; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-control { width: 100%; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px; box-sizing: border-box; }
        .card { background: #fff; padding: 20px; border-radius: 4px; margin-bottom: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        
        /* Lists */
        .list-item { display: flex; align-items: center; border-bottom: 1px solid #f0f0f0; padding: 15px 0; }
        .list-item:last-child { border-bottom: none; }
        .item-img { width: 100px; height: 60px; object-fit: cover; margin-right: 15px; border-radius: 4px; background: #eee; }
        .item-info { flex: 1; }
        .item-title { font-weight: bold; font-size: 16px; margin-bottom: 5px; }
        .item-meta { color: #999; font-size: 12px; }
        .item-actions { margin-left: 15px; }

        /* Post Specific */
        .post-images img { max-width: 150px; max-height: 150px; margin-right: 5px; margin-top: 5px; }
        
        /* Utility */
        .text-success { color: #52c41a; font-weight: bold; }
        .text-warning { color: #faad14; font-weight: bold; }
        .text-danger { color: #ff4d4f; font-weight: bold; }
    </style>
</head>
<body>

    <!-- Sidebar -->
        <div class="sidebar">
        <div class="sidebar-header">æ ¡å›­ç”Ÿæ´»åå°</div>
        <div class="nav-item active" onclick="switchTab('audit')">å¸–å­å®¡æ ¸</div>
        <div class="nav-item" onclick="switchTab('carousel')">è½®æ’­å›¾è®¾ç½®</div>
        <div class="nav-item" onclick="switchTab('news')">æ ¡å›­å’¨è¯¢/å…¬å‘Š</div>
        <div class="nav-item" onclick="switchTab('course')">è¯¾è¡¨ç®¡ç†</div>
        <div class="nav-item" onclick="switchTab('exam')">è€ƒè¯•å®‰æ’</div>
        <div class="nav-item" onclick="switchTab('canteen')">é£Ÿå ‚è®¢å•</div>
        <div class="nav-item" onclick="switchTab('venue')">åœºé¦†é¢„çº¦</div>
        <div class="nav-item" onclick="switchTab('ai')">AI è®¾ç½®</div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        
        <!-- AI Settings Section -->
        <div id="section-ai" class="section">
            <h2>AI åŠ©æ‰‹è®¾ç½® (DeepSeek)</h2>
            <div class="card">
                <h3>åŸºç¡€é…ç½®</h3>
                <div class="form-group">
                    <label>DeepSeek API Key</label>
                    <input type="password" id="ai-key" class="form-control" placeholder="sk-...">
                    <small style="color: #999;">å¯†é’¥å°†åŠ å¯†å­˜å‚¨ï¼Œå‰ç«¯ä¸å¯è§ã€‚</small>
                </div>
                <div class="form-group">
                    <label>çŸ¥è¯†åº“å†…å®¹ (TXT)</label>
                    <div style="margin-bottom: 5px;">
                        <input type="file" id="ai-txt-upload" accept=".txt" style="display:none" onchange="loadAiKbFile(this)">
                        <button class="btn btn-secondary btn-sm" onclick="document.getElementById('ai-txt-upload').click()">ğŸ“‚ ä»TXTæ–‡ä»¶å¯¼å…¥</button>
                    </div>
                    <textarea id="ai-kb" class="form-control" rows="15" placeholder="åœ¨æ­¤è¾“å…¥æ ¡å›­çŸ¥è¯†åº“å†…å®¹ï¼Œä¾‹å¦‚ï¼š
æ ¡è½¦æ¯å¤©æ—©ä¸Š7:00å¼€å§‹è¿è¡Œ...
ä¸€é£Ÿå ‚æœ‰å¤§ä¼—èœ..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="saveAiConfig()">ä¿å­˜é…ç½®</button>
            </div>
        </div>

        <!-- 1. Post Audit Section -->
        <div id="section-audit" class="section active">
            <h2>å¸–å­å®¡æ ¸</h2>
            <div id="audit-list">åŠ è½½ä¸­...</div>
        </div>

        <!-- 2. Carousel Management Section -->
        <div id="section-carousel" class="section">
            <h2>è½®æ’­å›¾ç®¡ç†</h2>
            
            <div class="card">
                <h3>æ·»åŠ è½®æ’­å›¾</h3>
                <div class="form-group">
                    <label>å›¾ç‰‡URL</label>
                    <input type="text" id="car-img" class="form-control" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label>æ ‡é¢˜ (å¯é€‰)</label>
                    <input type="text" id="car-title" class="form-control" placeholder="ä¾‹å¦‚ï¼šè¿æ–°æ™šä¼š">
                </div>
                <div class="form-group">
                    <label>è·³è½¬é“¾æ¥ (å¯é€‰)</label>
                    <input type="text" id="car-link" class="form-control" placeholder="/pages/...">
                </div>
                <div class="form-group">
                    <label>æƒé‡ (æ•°å­—è¶Šå¤§è¶Šé å‰)</label>
                    <input type="number" id="car-weight" class="form-control" value="0">
                </div>
                <button class="btn btn-primary" onclick="addCarousel()">æ·»åŠ </button>
            </div>

            <div class="card">
                <h3>è½®æ’­å›¾åˆ—è¡¨</h3>
                <div id="carousel-list"></div>
            </div>
        </div>

        <!-- 3. News Management Section -->
        <div id="section-news" class="section">
            <h2>èµ„è®¯ä¸å…¬å‘Š</h2>
            
            <div class="card">
                <h3>å‘å¸ƒæ–°å†…å®¹</h3>
                <div class="form-group">
                    <label>ç±»å‹</label>
                    <select id="news-type" class="form-control">
                        <option value="news">æ ¡å›­èµ„è®¯</option>
                        <option value="announcement">ç³»ç»Ÿå…¬å‘Š</option>
                        <option value="notice">é€šçŸ¥</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æ ‡é¢˜</label>
                    <input type="text" id="news-title" class="form-control">
                </div>
                <div class="form-group">
                    <label>å°é¢å›¾URL (å¯é€‰)</label>
                    <input type="text" id="news-cover" class="form-control">
                </div>
                <div class="form-group">
                    <label>æ‘˜è¦ (å¯é€‰)</label>
                    <input type="text" id="news-summary" class="form-control">
                </div>
                <div class="form-group">
                    <label>æ­£æ–‡å†…å®¹</label>
                    <textarea id="news-content" class="form-control" rows="5"></textarea>
                </div>
                <button class="btn btn-primary" onclick="addNews()">å‘å¸ƒ</button>
            </div>

            <div class="card">
                <h3>å†…å®¹åˆ—è¡¨</h3>
                <div id="news-list"></div>
            </div>
        </div>

        <!-- 4. Course Management Section -->
        <div id="section-course" class="section">
            <h2>è¯¾è¡¨ç®¡ç†</h2>
            <div class="card">
                <h3>æ·»åŠ è¯¾ç¨‹</h3>
                <div class="form-group">
                    <label>è¯¾ç¨‹åç§°</label>
                    <input type="text" id="course-name" class="form-control">
                </div>
                <div class="form-group">
                    <label>æ•™å¸ˆ</label>
                    <input type="text" id="course-teacher" class="form-control">
                </div>
                <div class="form-group">
                    <label>æ•™å®¤</label>
                    <input type="text" id="course-location" class="form-control">
                </div>
                <div class="form-group">
                    <label>æ˜ŸæœŸ (1-7)</label>
                    <select id="course-day" class="form-control">
                        <option value="1">å‘¨ä¸€</option>
                        <option value="2">å‘¨äºŒ</option>
                        <option value="3">å‘¨ä¸‰</option>
                        <option value="4">å‘¨å››</option>
                        <option value="5">å‘¨äº”</option>
                        <option value="6">å‘¨å…­</option>
                        <option value="7">å‘¨æ—¥</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å¼€å§‹æ—¶é—´ (å¦‚ 08:00)</label>
                    <input type="time" id="course-start" class="form-control" value="08:00">
                </div>
                <div class="form-group">
                    <label>ç»“æŸæ—¶é—´ (å¦‚ 09:35)</label>
                    <input type="time" id="course-end" class="form-control" value="09:35">
                </div>
                <div class="form-group">
                    <label>å‘¨æ•° (å¦‚ 1-16å‘¨)</label>
                    <input type="text" id="course-weeks" class="form-control" value="1-16å‘¨">
                </div>
                 <div class="form-group">
                    <label>é¢œè‰²</label>
                    <select id="course-color" class="form-control">
                        <option value="#E3F2FD">è“è‰²</option>
                        <option value="#FCE4EC">ç²‰è‰²</option>
                        <option value="#E8F5E9">ç»¿è‰²</option>
                        <option value="#FFF3E0">æ©™è‰²</option>
                        <option value="#F3E5F5">ç´«è‰²</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="addCourse()">æ·»åŠ è¯¾ç¨‹</button>
            </div>
            <div class="card">
                <h3>æ‰¹é‡å¯¼å…¥è¯¾è¡¨</h3>
                <div class="form-group">
                    <a class="btn btn-primary" href="/api/courses/template">ä¸‹è½½è¯¾è¡¨æ¨¡æ¿ï¼ˆCSVï¼‰</a>
                </div>
                <div class="form-group">
                    <label>ä¸Šä¼ å·²å¡«å†™æ¨¡æ¿</label>
                    <input type="file" id="course-import-file" class="form-control" accept=".csv,text/csv">
                </div>
                <div class="form-group" style="display:flex;align-items:center;gap:8px">
                    <input type="checkbox" id="course-import-replace" checked>
                    <label for="course-import-replace" style="margin:0;font-weight:normal">è¦†ç›–ç°æœ‰è¯¾è¡¨</label>
                </div>
                <button class="btn btn-success" onclick="importCourses()">ä¸Šä¼ å¹¶å¯¼å…¥</button>
            </div>
            <div class="card">
                <h3>è¯¾ç¨‹åˆ—è¡¨</h3>
                <div id="course-list"></div>
            </div>
        </div>

        <!-- 5. Exam Management Section -->
        <div id="section-exam" class="section">
            <h2>è€ƒè¯•å®‰æ’ç®¡ç†</h2>
            <div class="card">
                <h3>æ–°å¢è€ƒè¯•å®‰æ’</h3>
                <div class="form-group">
                    <label>è€ƒè¯•ç§‘ç›®</label>
                    <input type="text" id="exam-name" class="form-control">
                </div>
                <div class="form-group">
                    <label>ç±»å‹</label>
                    <input type="text" id="exam-type" class="form-control" value="æœŸæœ«">
                </div>
                <div class="form-group">
                    <label>è€ƒè¯•æ—¥æœŸ</label>
                    <input type="date" id="exam-date" class="form-control">
                </div>
                <div class="form-group" style="display:flex;gap:12px">
                    <div style="flex:1">
                        <label>å¼€å§‹æ—¶é—´</label>
                        <input type="time" id="exam-start" class="form-control" value="09:00">
                    </div>
                    <div style="flex:1">
                        <label>ç»“æŸæ—¶é—´</label>
                        <input type="time" id="exam-end" class="form-control" value="11:00">
                    </div>
                </div>
                <div class="form-group">
                    <label>åœ°ç‚¹</label>
                    <input type="text" id="exam-location" class="form-control" placeholder="æ•™å­¦æ¥¼ 301">
                </div>
                <div class="form-group">
                    <label>åº§å·</label>
                    <input type="text" id="exam-seat" class="form-control" placeholder="å¦‚ 15">
                </div>
                <div class="form-group">
                    <label>å¤‡æ³¨</label>
                    <input type="text" id="exam-remark" class="form-control" placeholder="å¦‚ æºå¸¦è¯ä»¶">
                </div>
                <button class="btn btn-primary" onclick="addExam()">æ·»åŠ </button>
            </div>
            <div class="card">
                <h3>è€ƒè¯•å®‰æ’åˆ—è¡¨</h3>
                <div id="exam-list"></div>
            </div>
        </div>

        <!-- 6. Canteen Order Management Section -->
        <div id="section-canteen" class="section">
            <h2>é£Ÿå ‚è®¢å•ç®¡ç†</h2>
            
             <!-- Menu Management -->
            <div class="card">
                <h3>èœè°±ç®¡ç†</h3>
                <div style="display:flex;gap:10px;margin-bottom:15px">
                     <button class="btn btn-primary" onclick="showAddDishModal()">æ‰‹åŠ¨æ·»åŠ èœå“</button>
                     <button class="btn btn-success" onclick="document.getElementById('dish-import-file').click()">æ‰¹é‡å¯¼å…¥(CSV)</button>
                     <input type="file" id="dish-import-file" style="display:none" accept=".csv" onchange="importDishes(this)">
                     <a href="#" onclick="downloadDishTemplate()" style="line-height:30px;margin-left:10px">ä¸‹è½½æ¨¡æ¿</a>
                </div>
                
                <!-- Add Dish Form (Hidden by default, shown via modal or toggle) - Let's use a simple toggle for now -->
                <div id="add-dish-form" style="display:none; border:1px solid #eee; padding:15px; margin-bottom:15px; background:#fafafa">
                    <h4>æ–°å¢èœå“</h4>
                    <div class="form-group">
                        <label>èœå“åç§°</label>
                        <input type="text" id="dish-name" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>åˆ†ç±» (å¦‚ï¼šæ—©é¤, åˆé¤, é¢é£Ÿ)</label>
                        <input type="text" id="dish-category" class="form-control" list="category-list">
                        <datalist id="category-list">
                            <option value="æ—©é¤"></option>
                            <option value="åˆé¤"></option>
                            <option value="æ™šé¤"></option>
                            <option value="é¥®å“"></option>
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label>ä»·æ ¼</label>
                        <input type="number" id="dish-price" class="form-control" step="0.5">
                    </div>
                    <div class="form-group">
                        <label>å›¾ç‰‡URL</label>
                        <input type="text" id="dish-image" class="form-control" placeholder="http://...">
                    </div>
                    <div class="form-group">
                        <label>æè¿°</label>
                        <input type="text" id="dish-desc" class="form-control">
                    </div>
                    <button class="btn btn-primary" onclick="addDish()">ä¿å­˜</button>
                    <button class="btn" onclick="document.getElementById('add-dish-form').style.display='none'">å–æ¶ˆ</button>
                </div>

                <div id="dish-list" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:15px;">
                    <!-- Dishes will be rendered here -->
                </div>
            </div>

            <div class="card">
                <h3>è®¢å•åˆ—è¡¨</h3>
                <div id="canteen-list">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- 7. Venue Management Section -->
        <div id="section-venue" class="section">
            <h2>åœºé¦†é¢„çº¦ç®¡ç†</h2>
            
            <div class="card">
                <h3>æ·»åŠ /ç®¡ç†åœºé¦†</h3>
                <div class="form-group">
                    <label>åœºé¦†åç§°</label>
                    <input type="text" id="venue-name" class="form-control" placeholder="å¦‚ï¼šä½“è‚²é¦†ç¾½æ¯›çƒåœº1å·">
                </div>
                <div class="form-group">
                    <label>ç±»å‹</label>
                    <select id="venue-type" class="form-control">
                        <option value="classroom">æ•™å®¤</option>
                        <option value="sports">ä½“è‚²åœºé¦†</option>
                        <option value="meeting">ä¼šè®®å®¤</option>
                        <option value="other">å…¶ä»–</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å¼€æ”¾æ—¶é—´</label>
                    <input type="text" id="venue-hours" class="form-control" value="08:00-22:00">
                </div>
                <div class="form-group">
                    <label>çŠ¶æ€</label>
                    <select id="venue-status" class="form-control">
                        <option value="open">å¼€æ”¾</option>
                        <option value="closed">å…³é—­</option>
                        <option value="maintenance">ç»´æŠ¤ä¸­</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="addVenue()">æ·»åŠ åœºé¦†</button>
            </div>

            <div class="card">
                <h3>åœºé¦†åˆ—è¡¨</h3>
                <div id="venue-list"></div>
            </div>

            <div class="card">
                <h3>å¼€æ”¾æ—¶æ®µç®¡ç†</h3>
                <div class="form-group">
                    <label>é€‰æ‹©åœºé¦†</label>
                    <select id="admin-slot-venue-id" class="form-control" onchange="fetchVenueSlots()"></select>
                </div>
                <div class="form-group">
                    <label>æ—¥æœŸ</label>
                    <input type="date" id="admin-slot-date" class="form-control" onchange="fetchVenueSlots()">
                </div>
                <div class="form-group" style="display:flex;gap:10px">
                    <div style="flex:1">
                        <label>å¼€å§‹æ—¶é—´</label>
                        <input type="time" id="admin-slot-start" class="form-control" value="08:00">
                    </div>
                    <div style="flex:1">
                        <label>ç»“æŸæ—¶é—´</label>
                        <input type="time" id="admin-slot-end" class="form-control" value="09:00">
                    </div>
                </div>
                <div class="form-group">
                    <label>çŠ¶æ€</label>
                    <select id="admin-slot-status" class="form-control">
                        <option value="open">å¼€æ”¾</option>
                        <option value="closed">å…³é—­</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="addVenueSlot()">æ·»åŠ æ—¶æ®µ</button>
                <div style="margin-top:10px" id="slot-list"></div>
            </div>

            <div class="card">
                <h3>æ‰‹åŠ¨å ç”¨/é¢„çº¦ (ç®¡ç†å‘˜)</h3>
                <div class="form-group">
                    <label>é€‰æ‹©åœºé¦†</label>
                    <select id="admin-book-venue-id" class="form-control"></select>
                </div>
                <div class="form-group">
                    <label>æ—¥æœŸ</label>
                    <input type="date" id="admin-book-date" class="form-control">
                </div>
                <div class="form-group" style="display:flex;gap:10px">
                    <div style="flex:1">
                        <label>å¼€å§‹æ—¶é—´</label>
                        <input type="time" id="admin-book-start" class="form-control" value="08:00">
                    </div>
                    <div style="flex:1">
                        <label>ç»“æŸæ—¶é—´</label>
                        <input type="time" id="admin-book-end" class="form-control" value="10:00">
                    </div>
                </div>
                <div class="form-group">
                    <label>å¤‡æ³¨/åŸå› </label>
                    <input type="text" id="admin-book-reason" class="form-control" placeholder="å¦‚ï¼šå†…éƒ¨ä¼šè®®å ç”¨">
                </div>
                <button class="btn btn-primary" onclick="addAdminBooking()">æäº¤å ç”¨</button>
            </div>

            <div class="card">
                <h3>é¢„çº¦å®¡æ ¸</h3>
                <div id="venue-booking-list"></div>
            </div>
        </div>

    </div>

    <script>
        // --- Tab Switching ---
        function switchTab(tab) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            
            event.currentTarget.classList.add('active');
            document.getElementById('section-' + tab).classList.add('active');
            
            if (tab === 'audit') fetchAuditPosts();
            if (tab === 'carousel') fetchCarousels();
            if (tab === 'news') fetchNews();
            if (tab === 'course') fetchCourses();
            if (tab === 'exam') fetchExams();
            if (tab === 'canteen') {
                fetchCanteenOrders();
                fetchDishes();
            }
            if (tab === 'venue') {
                fetchVenues();
                fetchVenueBookings();
            }
        }

        // --- 1. Audit Logic ---
        async function fetchAuditPosts() {
            const res = await fetch('/api/admin/posts');
            const json = await res.json();
            const container = document.getElementById('audit-list');
            
            if (json.data.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:#999">æš‚æ— å¾…å®¡æ ¸å¸–å­</div>';
                return;
            }

            container.innerHTML = json.data.map(post => {
                let imagesHtml = '';
                try {
                    const imgs = JSON.parse(post.images || '[]');
                    imagesHtml = imgs.map(src => `<a href="${src}" target="_blank"><img src="${src}"></a>`).join('');
                } catch(e) {}
                
                const typeMap = { 'forum': 'è®ºå›', 'second_hand': 'äºŒæ‰‹', 'lost_found': 'å¤±ç‰©', 'found': 'æ‹›é¢†' };

                return `
                    <div class="card">
                        <div style="display:flex;justify-content:space-between;margin-bottom:10px;color:#666">
                            <span>[${typeMap[post.type] || post.type}] ${post.category ? '('+post.category+')' : ''}</span>
                            <span>${new Date(post.createdAt).toLocaleString()}</span>
                        </div>
                        <div class="item-title">${post.title || 'æ— æ ‡é¢˜'}</div>
                        <div style="margin:10px 0">${post.content}</div>
                        <div class="post-images">${imagesHtml}</div>
                        <div style="margin-top:10px">
                            <button class="btn btn-success" onclick="auditPost(${post.id}, 1)">é€šè¿‡</button>
                            <button class="btn btn-danger" onclick="auditPost(${post.id}, 2)">æ‹’ç»</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function auditPost(id, status) {
            if (!confirm('ç¡®è®¤æ“ä½œï¼Ÿ')) return;
            await fetch(`/api/admin/posts/${id}/audit`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status })
            });
            fetchAuditPosts();
        }

        // --- 2. Carousel Logic ---
        async function fetchCarousels() {
            const res = await fetch('/api/carousels'); // Reuse public API or make admin specific if needed
            const json = await res.json();
            const container = document.getElementById('carousel-list');
            
            container.innerHTML = json.data.map(item => `
                <div class="list-item">
                    <img class="item-img" src="${item.imageUrl}">
                    <div class="item-info">
                        <div class="item-title">${item.title || 'æ— æ ‡é¢˜'}</div>
                        <div class="item-meta">é“¾æ¥: ${item.link || 'æ— '} | æƒé‡: ${item.weight}</div>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-danger" onclick="deleteCarousel(${item.id})">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        async function addCarousel() {
            const imageUrl = document.getElementById('car-img').value;
            if (!imageUrl) return alert('è¯·è¾“å…¥å›¾ç‰‡URL');
            
            await fetch('/api/admin/carousels', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    imageUrl,
                    title: document.getElementById('car-title').value,
                    link: document.getElementById('car-link').value,
                    weight: document.getElementById('car-weight').value
                })
            });
            
            // Clear inputs
            document.getElementById('car-img').value = '';
            document.getElementById('car-title').value = '';
            
            fetchCarousels();
        }

        async function deleteCarousel(id) {
            if (!confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ')) return;
            await fetch(`/api/admin/carousels/${id}`, { method: 'DELETE' });
            fetchCarousels();
        }

        // --- 3. News Logic ---
        async function fetchNews() {
            const res = await fetch('/api/admin/news');
            const json = await res.json();
            const container = document.getElementById('news-list');
            
            const typeMap = { 'news': 'èµ„è®¯', 'announcement': 'å…¬å‘Š', 'notice': 'é€šçŸ¥' };

            container.innerHTML = json.data.map(item => `
                <div class="list-item">
                    <div class="item-info">
                        <div class="item-title">[${typeMap[item.type]}] ${item.title}</div>
                        <div class="item-meta">${new Date(item.publishDate).toLocaleDateString()} | ${item.summary || 'æ— æ‘˜è¦'}</div>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-danger" onclick="deleteNews(${item.id})">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        async function addNews() {
            const title = document.getElementById('news-title').value;
            if (!title) return alert('è¯·è¾“å…¥æ ‡é¢˜');
            
            await fetch('/api/admin/news', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    type: document.getElementById('news-type').value,
                    title,
                    cover: document.getElementById('news-cover').value,
                    summary: document.getElementById('news-summary').value,
                    content: document.getElementById('news-content').value
                })
            });
            
            // Clear inputs
            document.getElementById('news-title').value = '';
            document.getElementById('news-content').value = '';
            
            fetchNews();
        }

        // --- 4. Course Logic ---
        async function fetchCourses() {
            const res = await fetch('/api/courses');
            const json = await res.json();
            const container = document.getElementById('course-list');
            
            container.innerHTML = json.data.map(item => `
                <div class="list-item">
                    <div class="item-info">
                        <div class="item-title">${item.name} (${item.teacher || 'å¾…å®š'})</div>
                        <div class="item-meta">
                            å‘¨${['','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'][item.dayOfWeek]} ${item.startTime}-${item.endTime} | ${item.location}
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-danger" onclick="deleteCourse(${item.id})">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        async function addCourse() {
            const name = document.getElementById('course-name').value;
            if (!name) return alert('è¯·è¾“å…¥è¯¾ç¨‹åç§°');
            
            await fetch('/api/courses', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name,
                    teacher: document.getElementById('course-teacher').value,
                    location: document.getElementById('course-location').value,
                    dayOfWeek: document.getElementById('course-day').value,
                    startTime: document.getElementById('course-start').value,
                    endTime: document.getElementById('course-end').value,
                    weeks: document.getElementById('course-weeks').value,
                    color: document.getElementById('course-color').value
                })
            });
            
            document.getElementById('course-name').value = '';
            fetchCourses();
        }

        async function importCourses() {
            const input = document.getElementById('course-import-file');
            const file = input.files && input.files[0];
            if (!file) return alert('è¯·é€‰æ‹©CSVæ–‡ä»¶');

            const csv = await readCsvFileSmart(file);
            const replace = document.getElementById('course-import-replace').checked;

            const res = await fetch('/api/courses/import', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ csv, replace })
            });
            const json = await res.json();
            if (json.code !== 0) {
                alert(json.error || 'å¯¼å…¥å¤±è´¥');
                return;
            }

            const created = json.data && json.data.created ? json.data.created : 0;
            const skipped = json.data && json.data.skipped ? json.data.skipped : 0;
            const errors = (json.data && json.data.errors) ? json.data.errors : [];

            let msg = `å¯¼å…¥å®Œæˆï¼šæ–°å¢${created}æ¡ï¼Œè·³è¿‡${skipped}æ¡`;
            if (errors.length) {
                msg += `\n\nå‰5æ¡é”™è¯¯ï¼š\n${errors.slice(0, 5).join('\n')}`;
            }
            alert(msg);

            input.value = '';
            fetchCourses();
        }

        async function fetchExams() {
            const res = await fetch('/api/exams');
            const json = await res.json();
            const container = document.getElementById('exam-list');
            container.innerHTML = json.data.map(item => `
                <div class="list-item">
                    <div class="item-info">
                        <div class="item-title">${item.name} (${item.type || 'æœŸæœ«'})</div>
                        <div class="item-meta">
                            ${item.examDate} ${item.startTime}-${item.endTime} | ${item.location || ''} åº§å·: ${item.seat || '-'}
                        </div>
                        ${item.remark ? `<div class="item-meta">${item.remark}</div>` : ''}
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-danger" onclick="deleteExam(${item.id})">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        async function addExam() {
            const name = document.getElementById('exam-name').value;
            const examDate = document.getElementById('exam-date').value;
            const startTime = document.getElementById('exam-start').value;
            const endTime = document.getElementById('exam-end').value;
            if (!name || !examDate || !startTime || !endTime) {
                alert('è¯·å¡«å†™ç§‘ç›®ã€æ—¥æœŸå’Œæ—¶é—´');
                return;
            }
            await fetch('/api/exams', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name,
                    type: document.getElementById('exam-type').value,
                    examDate,
                    startTime,
                    endTime,
                    location: document.getElementById('exam-location').value,
                    seat: document.getElementById('exam-seat').value,
                    remark: document.getElementById('exam-remark').value
                })
            });
            document.getElementById('exam-name').value = '';
            fetchExams();
        }

        async function deleteExam(id) {
            if (!confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ')) return;
            await fetch(`/api/exams/${id}`, { method: 'DELETE' });
            fetchExams();
        }

        async function readCsvFileSmart(file) {
            const buffer = await file.arrayBuffer();
            const bytes = new Uint8Array(buffer);
            const hasUtf8Bom = bytes.length >= 3 && bytes[0] === 0xEF && bytes[1] === 0xBB && bytes[2] === 0xBF;
            const utf8 = decodeWith(bytes, 'utf-8');
            if (hasUtf8Bom) return stripBom(utf8);
            if (looksGarbled(utf8)) {
                const gbk = decodeWith(bytes, 'gbk');
                if (!looksGarbled(gbk)) return gbk;
            }
            return stripBom(utf8);
        }

        function decodeWith(bytes, encoding) {
            try {
                return new TextDecoder(encoding, { fatal: false }).decode(bytes);
            } catch (e) {
                return new TextDecoder('utf-8', { fatal: false }).decode(bytes);
            }
        }

        function looksGarbled(text) {
            const s = String(text || '');
            if (!s) return false;
            const replacementCount = (s.match(/\uFFFD/g) || []).length;
            const ratio = replacementCount / Math.max(1, s.length);
            return replacementCount >= 3 || ratio > 0.01;
        }

        function stripBom(text) {
            const s = String(text || '');
            if (s.charCodeAt(0) === 0xFEFF) return s.slice(1);
            return s;
        }

        async function deleteCourse(id) {
            if (!confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ')) return;
            await fetch(`/api/courses/${id}`, { method: 'DELETE' });
            fetchCourses();
        }

        // --- 6. Canteen Logic ---
        async function fetchCanteenOrders() {
            const res = await fetch('/api/canteen/orders');
            const json = await res.json();
            const container = document.getElementById('canteen-list');
            
            if (!json.data || json.data.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:#999">æš‚æ— è®¢å•</div>';
                return;
            }

            container.innerHTML = json.data.map(item => `
                <div class="list-item">
                    <div class="item-info">
                        <div class="item-title">${item.dish}</div>
                        <div class="item-meta">
                            <span style="color:#1890ff;font-weight:bold">${item.name}</span> | 
                            <span>${item.phone}</span> | 
                            <span>å–é¤æ—¶é—´: ${item.diningTime}</span>
                        </div>
                        <div class="item-meta">çŠ¶æ€: 
                            <span class="${item.status === 'completed' ? 'text-success' : (item.status === 'pending' ? 'text-warning' : 'text-danger')}">
                                ${item.status === 'pending' ? 'å¾…å¤„ç†' : (item.status === 'completed' ? 'å·²å®Œæˆ' : 'å·²å–æ¶ˆ')}
                            </span>
                            ${item.remark ? ` | å¤‡æ³¨: ${item.remark}` : ''}
                        </div>
                        <div class="item-meta" style="font-size:11px;color:#ccc">
                             ä¸‹å•æ—¶é—´: ${new Date(item.createdAt).toLocaleString()}
                        </div>
                    </div>
                    <div class="item-actions">
                        ${item.status === 'pending' ? `
                        <button class="btn btn-success" onclick="updateCanteenOrder(${item.id}, 'completed')">å®Œæˆ</button>
                        <button class="btn btn-danger" onclick="updateCanteenOrder(${item.id}, 'cancelled')">å–æ¶ˆ</button>
                        ` : ''}
                        <button class="btn btn-danger" onclick="deleteCanteenOrder(${item.id})" style="margin-left:5px">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        async function updateCanteenOrder(id, status) {
            if (!confirm(`ç¡®è®¤æ ‡è®°ä¸º${status === 'completed' ? 'å®Œæˆ' : 'å–æ¶ˆ'}ï¼Ÿ`)) return;
            await fetch(`/api/canteen/orders/${id}/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status })
            });
            fetchCanteenOrders();
        }

        async function deleteCanteenOrder(id) {
             if (!confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ')) return;
             await fetch(`/api/canteen/orders/${id}`, { method: 'DELETE' });
             fetchCanteenOrders();
        }

        // --- 7. Canteen Dish Logic ---
        function showAddDishModal() {
            document.getElementById('add-dish-form').style.display = 'block';
        }

        async function fetchDishes() {
            const res = await fetch('/api/admin/canteen/dishes');
            const json = await res.json();
            const container = document.getElementById('dish-list');
            
            if (!json.data || json.data.length === 0) {
                container.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#999">æš‚æ— èœå“</div>';
                return;
            }

            container.innerHTML = json.data.map(item => `
                <div class="card" style="margin:0;padding:10px">
                    <div style="height:120px;background:#eee;margin-bottom:10px;border-radius:4px;overflow:hidden">
                        ${item.imageUrl ? `<img src="${item.imageUrl}" style="width:100%;height:100%;object-fit:cover">` : '<div style="text-align:center;line-height:120px;color:#999">æ— å›¾</div>'}
                    </div>
                    <div style="font-weight:bold">${item.name}</div>
                    <div style="font-size:12px;color:#666;margin:5px 0">
                        <span style="background:#e6f7ff;color:#1890ff;padding:2px 5px;border-radius:2px">${item.category}</span>
                        <span style="float:right;color:#f50;font-weight:bold">ï¿¥${item.price}</span>
                    </div>
                    <div style="font-size:12px;color:#999;margin-bottom:10px">${item.description || ''}</div>
                    <button class="btn btn-danger" style="width:100%;font-size:12px" onclick="deleteDish(${item.id})">åˆ é™¤</button>
                </div>
            `).join('');
        }

        async function addDish() {
            const name = document.getElementById('dish-name').value;
            const price = document.getElementById('dish-price').value;
            if (!name || !price) return alert('è¯·å¡«å†™åç§°å’Œä»·æ ¼');

            await fetch('/api/canteen/dishes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name,
                    price,
                    category: document.getElementById('dish-category').value || 'å…¶ä»–',
                    imageUrl: document.getElementById('dish-image').value,
                    description: document.getElementById('dish-desc').value
                })
            });
            
            document.getElementById('add-dish-form').style.display = 'none';
            // clear inputs
            document.getElementById('dish-name').value = '';
            document.getElementById('dish-price').value = '';
            fetchDishes();
        }

        async function deleteDish(id) {
            if (!confirm('ç¡®è®¤åˆ é™¤æ­¤èœå“ï¼Ÿ')) return;
            await fetch(`/api/canteen/dishes/${id}`, { method: 'DELETE' });
            fetchDishes();
        }

        async function importDishes(input) {
            const file = input.files && input.files[0];
            if (!file) return;

            const csvText = await readCsvFileSmart(file);
            // Parse CSV manually for simplicity or assume it's standard format
            // Simple parser: split lines, split commas (handling quotes is harder but let's assume simple csv)
            // Better: reuse a library or simple logic.
            // Format: name,category,price,description,imageUrl
            
            const lines = csvText.split(/\r?\n/).filter(l => l.trim());
            const headers = lines[0].split(',').map(h => h.trim());
            
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const parts = lines[i].split(','); // Simple split, assumes no commas in content
                if (parts.length < 2) continue;
                
                const row = {};
                // Map headers to fields if headers match, or just assume order: name, category, price...
                // Let's assume order: Name, Category, Price, Description, ImageUrl
                row.name = parts[0]?.trim();
                row.category = parts[1]?.trim();
                row.price = parts[2]?.trim();
                row.description = parts[3]?.trim();
                row.imageUrl = parts[4]?.trim();
                data.push(row);
            }

            if (data.length === 0) {
                alert('è§£æå¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©º');
                input.value = '';
                return;
            }

            if (!confirm(`è§£æåˆ°${data.length}æ¡æ•°æ®ï¼Œæ˜¯å¦å¯¼å…¥ï¼Ÿ`)) {
                input.value = '';
                return;
            }

            const res = await fetch('/api/canteen/dishes/import', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ csv: data, replace: false })
            });
            
            const json = await res.json();
            alert(`å¯¼å…¥æˆåŠŸ: ${json.data.created}, è·³è¿‡: ${json.data.skipped}`);
            input.value = '';
            fetchDishes();
        }

        function downloadDishTemplate() {
            const csv = 'Name,Category,Price,Description,ImageUrl\nçº¢çƒ§è‚‰,åˆé¤,12.5,è‚¥è€Œä¸è…»,http://...\nç•ªèŒ„ç‚’è›‹,åˆé¤,8.0,é…¸ç”œå¯å£,';
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'menu_template.csv';
            a.click();
        }

        // --- 8. Venue Logic ---
        async function fetchVenues() {
            const res = await fetch('/api/venues');
            const json = await res.json();
            const container = document.getElementById('venue-list');
            
            // Populate select for admin booking
            const select = document.getElementById('admin-book-venue-id');
            if (select) {
                select.innerHTML = json.data.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
            }
            const slotSelect = document.getElementById('admin-slot-venue-id');
            if (slotSelect) {
                slotSelect.innerHTML = json.data.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
            }
            
            container.innerHTML = json.data.map(item => `
                <div class="list-item">
                    <div class="item-info">
                        <div class="item-title">${item.name} (${item.type})</div>
                        <div class="item-meta">
                            å¼€æ”¾æ—¶é—´: ${item.openHours} | å½“å‰çŠ¶æ€: 
                            <span style="font-weight:bold; color:${item.status === 'open' ? 'green' : (item.status === 'maintenance' ? 'orange' : 'red')}">
                                ${item.status === 'open' ? 'å¼€æ”¾ä¸­' : (item.status === 'maintenance' ? 'ç»´æŠ¤ä¸­' : 'å·²å…³é—­')}
                            </span>
                        </div>
                        <div style="margin-top:5px">
                            <label style="font-size:12px;color:#666">è®¾ç½®çŠ¶æ€: </label>
                            <select onchange="updateVenueStatus(${item.id}, this.value)" style="padding:2px 5px;border-radius:4px;border:1px solid #ddd">
                                <option value="open" ${item.status === 'open' ? 'selected' : ''}>å¼€æ”¾</option>
                                <option value="closed" ${item.status === 'closed' ? 'selected' : ''}>å…³é—­</option>
                                <option value="maintenance" ${item.status === 'maintenance' ? 'selected' : ''}>ç»´æŠ¤</option>
                            </select>
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-danger" onclick="deleteVenue(${item.id})">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        async function addVenue() {
            const name = document.getElementById('venue-name').value;
            if (!name) return alert('è¯·è¾“å…¥åœºé¦†åç§°');
            
            await fetch('/api/venues', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name,
                    type: document.getElementById('venue-type').value,
                    status: document.getElementById('venue-status').value,
                    openHours: document.getElementById('venue-hours').value
                })
            });
            
            document.getElementById('venue-name').value = '';
            fetchVenues();
        }

        async function updateVenueStatus(id, status) {
            await fetch(`/api/venues/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status })
            });
            fetchVenues();
        }

        async function deleteVenue(id) {
            if (!confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ')) return;
            await fetch(`/api/venues/${id}`, { method: 'DELETE' });
            fetchVenues();
        }

        async function fetchVenueSlots() {
            const venueId = document.getElementById('admin-slot-venue-id').value;
            const date = document.getElementById('admin-slot-date').value;
            if (!venueId || !date) {
                document.getElementById('slot-list').innerHTML = '';
                return;
            }
            const res = await fetch(`/api/venues/${venueId}/slots?date=${date}`);
            const json = await res.json();
            const container = document.getElementById('slot-list');
            if (!json.data || json.data.length === 0) {
                container.innerHTML = '<div style="color:#999;text-align:center">æš‚æ— æ—¶æ®µ</div>';
                return;
            }
            container.innerHTML = json.data.map(item => `
                <div class="list-item">
                    <div class="item-info">
                        <div class="item-title">${item.slotDate} ${item.startTime}-${item.endTime}</div>
                        <div class="item-meta">çŠ¶æ€: ${item.status === 'open' ? 'å¼€æ”¾' : 'å…³é—­'} | ${item.available ? 'å¯é¢„çº¦' : 'å·²å ç”¨'}</div>
                    </div>
                    <div class="item-actions">
                        <select onchange="updateVenueSlotStatus(${item.id}, this.value)" style="padding:4px 6px;border-radius:4px;border:1px solid #ddd">
                            <option value="open" ${item.status === 'open' ? 'selected' : ''}>å¼€æ”¾</option>
                            <option value="closed" ${item.status === 'closed' ? 'selected' : ''}>å…³é—­</option>
                        </select>
                        <button class="btn btn-danger" onclick="deleteVenueSlot(${item.id})" style="margin-left:6px">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        async function addVenueSlot() {
            const venueId = document.getElementById('admin-slot-venue-id').value;
            const slotDate = document.getElementById('admin-slot-date').value;
            const startTime = document.getElementById('admin-slot-start').value;
            const endTime = document.getElementById('admin-slot-end').value;
            const status = document.getElementById('admin-slot-status').value;
            if (!venueId || !slotDate || !startTime || !endTime) {
                return alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
            }
            const res = await fetch('/api/venues/slots', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ venueId, slotDate, startTime, endTime, status })
            });
            const json = await res.json();
            if (json.code !== 0) {
                alert('æ·»åŠ å¤±è´¥: ' + json.error);
                return;
            }
            fetchVenueSlots();
        }

        async function updateVenueSlotStatus(id, status) {
            await fetch(`/api/venues/slots/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status })
            });
            fetchVenueSlots();
        }

        async function deleteVenueSlot(id) {
            if (!confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ')) return;
            await fetch(`/api/venues/slots/${id}`, { method: 'DELETE' });
            fetchVenueSlots();
        }

        async function addAdminBooking() {
            const venueId = document.getElementById('admin-book-venue-id').value;
            const bookDate = document.getElementById('admin-book-date').value;
            const startTime = document.getElementById('admin-book-start').value;
            const endTime = document.getElementById('admin-book-end').value;
            const reason = document.getElementById('admin-book-reason').value;

            if (!venueId || !bookDate || !startTime || !endTime) {
                return alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
            }

            const res = await fetch('/api/venues/bookings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    venueId, bookDate, startTime, endTime, reason,
                    isAdmin: true,
                    userName: 'ç®¡ç†å‘˜',
                    userPhone: 'Admin'
                })
            });
            
            const json = await res.json();
            if (json.code !== 0) {
                alert('é¢„çº¦å¤±è´¥: ' + json.error);
            } else {
                alert('å ç”¨æˆåŠŸ');
                fetchVenueBookings();
            }
        }

        async function fetchVenueBookings() {
            const res = await fetch('/api/venues/bookings?isAdmin=true');
            const json = await res.json();
            const container = document.getElementById('venue-booking-list');
            
            if (!json.data || json.data.length === 0) {
                container.innerHTML = '<div style="color:#999;text-align:center">æš‚æ— é¢„çº¦</div>';
                return;
            }

            container.innerHTML = json.data.map(item => `
                <div class="list-item">
                    <div class="item-info">
                        <div class="item-title">${item.venueName || 'æœªçŸ¥åœºé¦†'}</div>
                        <div class="item-meta">
                            æ—¥æœŸ: ${item.bookDate} | æ—¶é—´: ${item.startTime}-${item.endTime}
                        </div>
                        <div class="item-meta">
                            é¢„çº¦äºº: ${item.userName || item.openid || 'ç”¨æˆ·'} ${item.userPhone ? '('+item.userPhone+')' : ''} | çŠ¶æ€: 
                            <span class="${item.status === 'approved' ? 'text-success' : (item.status === 'pending' ? 'text-warning' : 'text-danger')}">
                                ${item.status === 'pending' ? 'å¾…å®¡æ ¸' : (item.status === 'approved' ? 'å·²é€šè¿‡' : 'å·²æ‹’ç»')}
                            </span>
                        </div>
                    </div>
                    <div class="item-actions">
                        ${item.status === 'pending' ? `
                            <button class="btn btn-success" onclick="auditVenueBooking(${item.id}, 'approved')">é€šè¿‡</button>
                            <button class="btn btn-danger" onclick="auditVenueBooking(${item.id}, 'rejected')">æ‹’ç»</button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function auditVenueBooking(id, status) {
            if (!confirm(`ç¡®è®¤${status === 'approved' ? 'é€šè¿‡' : 'æ‹’ç»'}æ­¤é¢„çº¦ï¼Ÿ`)) return;
            await fetch(`/api/venues/bookings/${id}/audit`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status })
            });
            fetchVenueBookings();
        }

        // --- 9. AI Logic ---
        async function fetchAiConfig() {
            try {
                const res = await fetch('/api/ai/config');
                const json = await res.json();
                if (json.code === 0) {
                    const { hasApiKey, knowledgeBase } = json.data;
                    document.getElementById('ai-kb').value = knowledgeBase || '';
                    if (hasApiKey) {
                        document.getElementById('ai-key').setAttribute('placeholder', 'å·²é…ç½® (è¾“å…¥æ–°å¯†é’¥ä»¥è¦†ç›–)');
                    }
                }
            } catch (e) {
                console.error('Fetch AI config failed', e);
            }
        }

        async function saveAiConfig() {
            const apiKey = document.getElementById('ai-key').value.trim();
            const knowledgeBase = document.getElementById('ai-kb').value.trim();
            
            const payload = { knowledgeBase };
            if (apiKey) {
                payload.apiKey = apiKey;
            }

            try {
                const res = await fetch('/api/ai/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const json = await res.json();
                if (json.code === 0) {
                    alert('é…ç½®å·²ä¿å­˜');
                    document.getElementById('ai-key').value = ''; // clear key input
                    fetchAiConfig();
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + (json.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (e) {
                alert('è¯·æ±‚å¤±è´¥');
            }
        }

        function loadAiKbFile(input) {
            const file = input.files && input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('ai-kb').value = e.target.result;
            };
            reader.readAsText(file);
            input.value = '';
        }

        // --- Init ---
        function switchTab(tab) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            
            // Highlight nav
            const navItems = document.querySelectorAll('.nav-item');
            if (tab === 'audit') navItems[0].classList.add('active');
            if (tab === 'carousel') navItems[1].classList.add('active');
            if (tab === 'news') navItems[2].classList.add('active');
            if (tab === 'course') navItems[3].classList.add('active');
            if (tab === 'exam') navItems[4].classList.add('active');
            if (tab === 'canteen') navItems[5].classList.add('active');
            if (tab === 'venue') navItems[6].classList.add('active');
            if (tab === 'ai') navItems[7].classList.add('active');

            // Show section
            document.getElementById(`section-${tab}`).classList.add('active');
            
            // Fetch data
            if (tab === 'audit') fetchAuditPosts();
            if (tab === 'carousel') fetchCarousels();
            if (tab === 'news') fetchNews();
            if (tab === 'course') fetchCourses();
            if (tab === 'exam') fetchExams();
            if (tab === 'canteen') fetchDishes();
            if (tab === 'venue') fetchVenues();
            if (tab === 'ai') fetchAiConfig();
        }

        // Initial Load
        fetchAuditPosts();
    </script>
</body>
</html>

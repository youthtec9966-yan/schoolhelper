<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校园生活管理后台</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; margin: 0; display: flex; height: 100vh; background-color: #f4f5f7; }
        
        /* Sidebar */
        .sidebar { width: 240px; background-color: #001529; color: #fff; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; font-size: 20px; font-weight: bold; text-align: center; border-bottom: 1px solid #002140; }
        .nav-item { padding: 15px 20px; cursor: pointer; transition: background 0.3s; }
        .nav-item:hover { background-color: #1890ff; }
        .nav-item.active { background-color: #1890ff; }
        
        /* Main Content */
        .main-content { flex: 1; padding: 20px; overflow-y: auto; }
        .section { display: none; }
        .section.active { display: block; }
        
        /* Common */
        h2 { margin-top: 0; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; color: white; font-size: 14px; }
        .btn-primary { background-color: #1890ff; }
        .btn-danger { background-color: #ff4d4f; }
        .btn-success { background-color: #52c41a; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-control { width: 100%; padding: 8px; border: 1px solid #d9d9d9; border-radius: 4px; box-sizing: border-box; }
        .card { background: #fff; padding: 20px; border-radius: 4px; margin-bottom: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        
        /* Lists */
        .list-item { display: flex; align-items: center; border-bottom: 1px solid #f0f0f0; padding: 15px 0; }
        .list-item:last-child { border-bottom: none; }
        .item-img { width: 100px; height: 60px; object-fit: cover; margin-right: 15px; border-radius: 4px; background: #eee; }
        .item-info { flex: 1; }
        .item-title { font-weight: bold; font-size: 16px; margin-bottom: 5px; }
        .item-meta { color: #999; font-size: 12px; }
        .item-actions { margin-left: 15px; }

        /* Post Specific */
        .post-images img { max-width: 150px; max-height: 150px; margin-right: 5px; margin-top: 5px; }
    </style>
</head>
<body>

    <!-- Sidebar -->
        <div class="sidebar">
        <div class="sidebar-header">校园生活后台</div>
        <div class="nav-item active" onclick="switchTab('audit')">帖子审核</div>
        <div class="nav-item" onclick="switchTab('carousel')">轮播图设置</div>
        <div class="nav-item" onclick="switchTab('news')">校园咨询/公告</div>
        <div class="nav-item" onclick="switchTab('course')">课表管理</div>
        <div class="nav-item" onclick="switchTab('exam')">考试安排</div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        
        <!-- 1. Post Audit Section -->
        <div id="section-audit" class="section active">
            <h2>帖子审核</h2>
            <div id="audit-list">加载中...</div>
        </div>

        <!-- 2. Carousel Management Section -->
        <div id="section-carousel" class="section">
            <h2>轮播图管理</h2>
            
            <div class="card">
                <h3>添加轮播图</h3>
                <div class="form-group">
                    <label>图片URL</label>
                    <input type="text" id="car-img" class="form-control" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label>标题 (可选)</label>
                    <input type="text" id="car-title" class="form-control" placeholder="例如：迎新晚会">
                </div>
                <div class="form-group">
                    <label>跳转链接 (可选)</label>
                    <input type="text" id="car-link" class="form-control" placeholder="/pages/...">
                </div>
                <div class="form-group">
                    <label>权重 (数字越大越靠前)</label>
                    <input type="number" id="car-weight" class="form-control" value="0">
                </div>
                <button class="btn btn-primary" onclick="addCarousel()">添加</button>
            </div>

            <div class="card">
                <h3>轮播图列表</h3>
                <div id="carousel-list"></div>
            </div>
        </div>

        <!-- 3. News Management Section -->
        <div id="section-news" class="section">
            <h2>资讯与公告</h2>
            
            <div class="card">
                <h3>发布新内容</h3>
                <div class="form-group">
                    <label>类型</label>
                    <select id="news-type" class="form-control">
                        <option value="news">校园资讯</option>
                        <option value="announcement">系统公告</option>
                        <option value="notice">通知</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>标题</label>
                    <input type="text" id="news-title" class="form-control">
                </div>
                <div class="form-group">
                    <label>封面图URL (可选)</label>
                    <input type="text" id="news-cover" class="form-control">
                </div>
                <div class="form-group">
                    <label>摘要 (可选)</label>
                    <input type="text" id="news-summary" class="form-control">
                </div>
                <div class="form-group">
                    <label>正文内容</label>
                    <textarea id="news-content" class="form-control" rows="5"></textarea>
                </div>
                <button class="btn btn-primary" onclick="addNews()">发布</button>
            </div>

            <div class="card">
                <h3>内容列表</h3>
                <div id="news-list"></div>
            </div>
        </div>

        <!-- 4. Course Management Section -->
        <div id="section-course" class="section">
            <h2>课表管理</h2>
            <div class="card">
                <h3>添加课程</h3>
                <div class="form-group">
                    <label>课程名称</label>
                    <input type="text" id="course-name" class="form-control">
                </div>
                <div class="form-group">
                    <label>教师</label>
                    <input type="text" id="course-teacher" class="form-control">
                </div>
                <div class="form-group">
                    <label>教室</label>
                    <input type="text" id="course-location" class="form-control">
                </div>
                <div class="form-group">
                    <label>星期 (1-7)</label>
                    <select id="course-day" class="form-control">
                        <option value="1">周一</option>
                        <option value="2">周二</option>
                        <option value="3">周三</option>
                        <option value="4">周四</option>
                        <option value="5">周五</option>
                        <option value="6">周六</option>
                        <option value="7">周日</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>开始时间 (如 08:00)</label>
                    <input type="time" id="course-start" class="form-control" value="08:00">
                </div>
                <div class="form-group">
                    <label>结束时间 (如 09:35)</label>
                    <input type="time" id="course-end" class="form-control" value="09:35">
                </div>
                <div class="form-group">
                    <label>周数 (如 1-16周)</label>
                    <input type="text" id="course-weeks" class="form-control" value="1-16周">
                </div>
                 <div class="form-group">
                    <label>颜色</label>
                    <select id="course-color" class="form-control">
                        <option value="#E3F2FD">蓝色</option>
                        <option value="#FCE4EC">粉色</option>
                        <option value="#E8F5E9">绿色</option>
                        <option value="#FFF3E0">橙色</option>
                        <option value="#F3E5F5">紫色</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="addCourse()">添加课程</button>
            </div>
            <div class="card">
                <h3>批量导入课表</h3>
                <div class="form-group">
                    <a class="btn btn-primary" href="/api/courses/template">下载课表模板（CSV）</a>
                </div>
                <div class="form-group">
                    <label>上传已填写模板</label>
                    <input type="file" id="course-import-file" class="form-control" accept=".csv,text/csv">
                </div>
                <div class="form-group" style="display:flex;align-items:center;gap:8px">
                    <input type="checkbox" id="course-import-replace" checked>
                    <label for="course-import-replace" style="margin:0;font-weight:normal">覆盖现有课表</label>
                </div>
                <button class="btn btn-success" onclick="importCourses()">上传并导入</button>
            </div>
            <div class="card">
                <h3>课程列表</h3>
                <div id="course-list"></div>
            </div>
        </div>

        <!-- 5. Exam Management Section -->
        <div id="section-exam" class="section">
            <h2>考试安排管理</h2>
            <div class="card">
                <h3>新增考试安排</h3>
                <div class="form-group">
                    <label>考试科目</label>
                    <input type="text" id="exam-name" class="form-control">
                </div>
                <div class="form-group">
                    <label>类型</label>
                    <input type="text" id="exam-type" class="form-control" value="期末">
                </div>
                <div class="form-group">
                    <label>考试日期</label>
                    <input type="date" id="exam-date" class="form-control">
                </div>
                <div class="form-group" style="display:flex;gap:12px">
                    <div style="flex:1">
                        <label>开始时间</label>
                        <input type="time" id="exam-start" class="form-control" value="09:00">
                    </div>
                    <div style="flex:1">
                        <label>结束时间</label>
                        <input type="time" id="exam-end" class="form-control" value="11:00">
                    </div>
                </div>
                <div class="form-group">
                    <label>地点</label>
                    <input type="text" id="exam-location" class="form-control" placeholder="教学楼 301">
                </div>
                <div class="form-group">
                    <label>座号</label>
                    <input type="text" id="exam-seat" class="form-control" placeholder="如 15">
                </div>
                <div class="form-group">
                    <label>备注</label>
                    <input type="text" id="exam-remark" class="form-control" placeholder="如 携带证件">
                </div>
                <button class="btn btn-primary" onclick="addExam()">添加</button>
            </div>
            <div class="card">
                <h3>考试安排列表</h3>
                <div id="exam-list"></div>
            </div>
        </div>

    </div>

    <script>
        // --- Tab Switching ---
        function switchTab(tab) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            
            event.currentTarget.classList.add('active');
            document.getElementById('section-' + tab).classList.add('active');
            
            if (tab === 'audit') fetchAuditPosts();
            if (tab === 'carousel') fetchCarousels();
            if (tab === 'news') fetchNews();
            if (tab === 'course') fetchCourses();
            if (tab === 'exam') fetchExams();
        }

        // --- 1. Audit Logic ---
        async function fetchAuditPosts() {
            const res = await fetch('/api/admin/posts');
            const json = await res.json();
            const container = document.getElementById('audit-list');
            
            if (json.data.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:#999">暂无待审核帖子</div>';
                return;
            }

            container.innerHTML = json.data.map(post => {
                let imagesHtml = '';
                try {
                    const imgs = JSON.parse(post.images || '[]');
                    imagesHtml = imgs.map(src => `<a href="${src}" target="_blank"><img src="${src}"></a>`).join('');
                } catch(e) {}
                
                const typeMap = { 'forum': '论坛', 'second_hand': '二手', 'lost_found': '失物', 'found': '招领' };

                return `
                    <div class="card">
                        <div style="display:flex;justify-content:space-between;margin-bottom:10px;color:#666">
                            <span>[${typeMap[post.type] || post.type}] ${post.category ? '('+post.category+')' : ''}</span>
                            <span>${new Date(post.createdAt).toLocaleString()}</span>
                        </div>
                        <div class="item-title">${post.title || '无标题'}</div>
                        <div style="margin:10px 0">${post.content}</div>
                        <div class="post-images">${imagesHtml}</div>
                        <div style="margin-top:10px">
                            <button class="btn btn-success" onclick="auditPost(${post.id}, 1)">通过</button>
                            <button class="btn btn-danger" onclick="auditPost(${post.id}, 2)">拒绝</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function auditPost(id, status) {
            if (!confirm('确认操作？')) return;
            await fetch(`/api/admin/posts/${id}/audit`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status })
            });
            fetchAuditPosts();
        }

        // --- 2. Carousel Logic ---
        async function fetchCarousels() {
            const res = await fetch('/api/carousels'); // Reuse public API or make admin specific if needed
            const json = await res.json();
            const container = document.getElementById('carousel-list');
            
            container.innerHTML = json.data.map(item => `
                <div class="list-item">
                    <img class="item-img" src="${item.imageUrl}">
                    <div class="item-info">
                        <div class="item-title">${item.title || '无标题'}</div>
                        <div class="item-meta">链接: ${item.link || '无'} | 权重: ${item.weight}</div>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-danger" onclick="deleteCarousel(${item.id})">删除</button>
                    </div>
                </div>
            `).join('');
        }

        async function addCarousel() {
            const imageUrl = document.getElementById('car-img').value;
            if (!imageUrl) return alert('请输入图片URL');
            
            await fetch('/api/admin/carousels', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    imageUrl,
                    title: document.getElementById('car-title').value,
                    link: document.getElementById('car-link').value,
                    weight: document.getElementById('car-weight').value
                })
            });
            
            // Clear inputs
            document.getElementById('car-img').value = '';
            document.getElementById('car-title').value = '';
            
            fetchCarousels();
        }

        async function deleteCarousel(id) {
            if (!confirm('确认删除？')) return;
            await fetch(`/api/admin/carousels/${id}`, { method: 'DELETE' });
            fetchCarousels();
        }

        // --- 3. News Logic ---
        async function fetchNews() {
            const res = await fetch('/api/admin/news');
            const json = await res.json();
            const container = document.getElementById('news-list');
            
            const typeMap = { 'news': '资讯', 'announcement': '公告', 'notice': '通知' };

            container.innerHTML = json.data.map(item => `
                <div class="list-item">
                    <div class="item-info">
                        <div class="item-title">[${typeMap[item.type]}] ${item.title}</div>
                        <div class="item-meta">${new Date(item.publishDate).toLocaleDateString()} | ${item.summary || '无摘要'}</div>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-danger" onclick="deleteNews(${item.id})">删除</button>
                    </div>
                </div>
            `).join('');
        }

        async function addNews() {
            const title = document.getElementById('news-title').value;
            if (!title) return alert('请输入标题');
            
            await fetch('/api/admin/news', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    type: document.getElementById('news-type').value,
                    title,
                    cover: document.getElementById('news-cover').value,
                    summary: document.getElementById('news-summary').value,
                    content: document.getElementById('news-content').value
                })
            });
            
            // Clear inputs
            document.getElementById('news-title').value = '';
            document.getElementById('news-content').value = '';
            
            fetchNews();
        }

        // --- 4. Course Logic ---
        async function fetchCourses() {
            const res = await fetch('/api/courses');
            const json = await res.json();
            const container = document.getElementById('course-list');
            
            container.innerHTML = json.data.map(item => `
                <div class="list-item">
                    <div class="item-info">
                        <div class="item-title">${item.name} (${item.teacher || '待定'})</div>
                        <div class="item-meta">
                            周${['','一','二','三','四','五','六','日'][item.dayOfWeek]} ${item.startTime}-${item.endTime} | ${item.location}
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-danger" onclick="deleteCourse(${item.id})">删除</button>
                    </div>
                </div>
            `).join('');
        }

        async function addCourse() {
            const name = document.getElementById('course-name').value;
            if (!name) return alert('请输入课程名称');
            
            await fetch('/api/courses', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name,
                    teacher: document.getElementById('course-teacher').value,
                    location: document.getElementById('course-location').value,
                    dayOfWeek: document.getElementById('course-day').value,
                    startTime: document.getElementById('course-start').value,
                    endTime: document.getElementById('course-end').value,
                    weeks: document.getElementById('course-weeks').value,
                    color: document.getElementById('course-color').value
                })
            });
            
            document.getElementById('course-name').value = '';
            fetchCourses();
        }

        async function importCourses() {
            const input = document.getElementById('course-import-file');
            const file = input.files && input.files[0];
            if (!file) return alert('请选择CSV文件');

            const csv = await readCsvFileSmart(file);
            const replace = document.getElementById('course-import-replace').checked;

            const res = await fetch('/api/courses/import', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ csv, replace })
            });
            const json = await res.json();
            if (json.code !== 0) {
                alert(json.error || '导入失败');
                return;
            }

            const created = json.data && json.data.created ? json.data.created : 0;
            const skipped = json.data && json.data.skipped ? json.data.skipped : 0;
            const errors = (json.data && json.data.errors) ? json.data.errors : [];

            let msg = `导入完成：新增${created}条，跳过${skipped}条`;
            if (errors.length) {
                msg += `\n\n前5条错误：\n${errors.slice(0, 5).join('\n')}`;
            }
            alert(msg);

            input.value = '';
            fetchCourses();
        }

        async function fetchExams() {
            const res = await fetch('/api/exams');
            const json = await res.json();
            const container = document.getElementById('exam-list');
            container.innerHTML = json.data.map(item => `
                <div class="list-item">
                    <div class="item-info">
                        <div class="item-title">${item.name} (${item.type || '期末'})</div>
                        <div class="item-meta">
                            ${item.examDate} ${item.startTime}-${item.endTime} | ${item.location || ''} 座号: ${item.seat || '-'}
                        </div>
                        ${item.remark ? `<div class="item-meta">${item.remark}</div>` : ''}
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-danger" onclick="deleteExam(${item.id})">删除</button>
                    </div>
                </div>
            `).join('');
        }

        async function addExam() {
            const name = document.getElementById('exam-name').value;
            const examDate = document.getElementById('exam-date').value;
            const startTime = document.getElementById('exam-start').value;
            const endTime = document.getElementById('exam-end').value;
            if (!name || !examDate || !startTime || !endTime) {
                alert('请填写科目、日期和时间');
                return;
            }
            await fetch('/api/exams', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name,
                    type: document.getElementById('exam-type').value,
                    examDate,
                    startTime,
                    endTime,
                    location: document.getElementById('exam-location').value,
                    seat: document.getElementById('exam-seat').value,
                    remark: document.getElementById('exam-remark').value
                })
            });
            document.getElementById('exam-name').value = '';
            fetchExams();
        }

        async function deleteExam(id) {
            if (!confirm('确认删除？')) return;
            await fetch(`/api/exams/${id}`, { method: 'DELETE' });
            fetchExams();
        }

        async function readCsvFileSmart(file) {
            const buffer = await file.arrayBuffer();
            const bytes = new Uint8Array(buffer);
            const hasUtf8Bom = bytes.length >= 3 && bytes[0] === 0xEF && bytes[1] === 0xBB && bytes[2] === 0xBF;
            const utf8 = decodeWith(bytes, 'utf-8');
            if (hasUtf8Bom) return stripBom(utf8);
            if (looksGarbled(utf8)) {
                const gbk = decodeWith(bytes, 'gbk');
                if (!looksGarbled(gbk)) return gbk;
            }
            return stripBom(utf8);
        }

        function decodeWith(bytes, encoding) {
            try {
                return new TextDecoder(encoding, { fatal: false }).decode(bytes);
            } catch (e) {
                return new TextDecoder('utf-8', { fatal: false }).decode(bytes);
            }
        }

        function looksGarbled(text) {
            const s = String(text || '');
            if (!s) return false;
            const replacementCount = (s.match(/\uFFFD/g) || []).length;
            const ratio = replacementCount / Math.max(1, s.length);
            return replacementCount >= 3 || ratio > 0.01;
        }

        function stripBom(text) {
            const s = String(text || '');
            if (s.charCodeAt(0) === 0xFEFF) return s.slice(1);
            return s;
        }

        async function deleteCourse(id) {
            if (!confirm('确认删除？')) return;
            await fetch(`/api/courses/${id}`, { method: 'DELETE' });
            fetchCourses();
        }

        // Init
        fetchAuditPosts();
    </script>
</body>
</html>
